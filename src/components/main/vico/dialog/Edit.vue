<script setup>
defineOptions({
  name: 'MainVicoDialogEdit',
})

import { api } from 'boot/axios'
import { DateTime } from 'boot/luxon'
import { useVuelidate, required, minLength } from 'boot/vuelidate'
import { ref, computed } from 'vue'
import { Loading, Notify } from 'quasar'
import { useStoreGlobal } from '../../../../stores/storeGlobal.js'
import { useStoreMain } from '../../../../stores/storeMain.js'
import { useStoreUser } from '../../../../stores/storeUser.js'

const storeGlobal = useStoreGlobal()
const storeMain = useStoreMain()
const storeUser = useStoreUser()

const dialog = ref(false)

const optionObject = computed(() => storeGlobal.optionObject)
const optionTypeVico = computed(() => storeGlobal.optionTypeVico)
const optionDepartament = computed(() => storeGlobal.optionDepartament)

const vico = ref()

const dateValidate = (value) => {
  const date = DateTime.fromFormat(value, 'dd.LL.yyyy')
  return date.invalid == null
}

const timeValidate = (value) => {
  const date = DateTime.fromFormat(value, 'hh:mm')
  return date.invalid == null
}

const rules = computed(() => ({
  date: {
    required,
    min: minLength(ref(10)),
    dateValidate,
  },
  timeStart: { required, min: minLength(ref(5)), timeValidate },
  timeEnd: { required, min: minLength(ref(5)), timeValidate },
  objectInitiator: { required },
  objectInvited: { required },
  typeVico: { required },
  topic: { required },
  departamentInitiator: { required },
  departamentInvited: { required },
  contactName: { required },
  contactPhone: { required },
}))

const form = ref()

const formValidate = useVuelidate(rules, vico)

const dialogOpen = () => {
  Loading.show()
  if (storeMain.isSelect) {
    api({
      method: 'post',
      url: storeGlobal.getAjaxUri('vico/one'),
      data: {
        id: storeMain.selectId,
      },
      timeout: 10000,
      responseType: 'json',
    })
      .then((response) => {
        if (response.data.success) {
          vico.value = storeGlobal.getVicoTemplate()

          vico.value.date = storeGlobal.getDate(
            response.data.vico.dateTimeStart
          )
          vico.value.timeStart = storeGlobal.getTime(
            response.data.vico.dateTimeStart
          )
          vico.value.timeEnd = storeGlobal.getTime(
            response.data.vico.dateTimeEnd
          )

          vico.value.topic = response.data.vico.topic
          vico.value.contactName = response.data.vico.contactName
          vico.value.contactPhone = response.data.vico.contactPhone

          vico.value.typeVico = storeGlobal.getOptionTypeVicoByName(
            response.data.vico.typeVico
          )

          vico.value.objectInitiator = storeGlobal.getOptionObjectByName(
            response.data.vico.objectInitiator
          )

          vico.value.objectInvited = response.data.vico.objectInvited

          vico.value.objectInvited.forEach((item, index) => {
            vico.value.objectInvited.splice(
              index,
              1,
              storeGlobal.getOptionObjectByName(item)
            )
          })

          vico.value.departamentInitiator =
            storeGlobal.getOptionDepartamentByName(
              response.data.vico.departamentInitiator
            )

          vico.value.departamentInvited = response.data.vico.departamentInvited

          vico.value.departamentInvited.forEach((item, index) => {
            vico.value.departamentInvited.splice(
              index,
              1,
              storeGlobal.getOptionDepartamentByName(item)
            )
          })

          dialog.value = true
          Loading.hide()
        } else {
          Notify.create({
            progress: true,
            color: 'negative',
            position: 'top',
            message: '<b>' + response.data.message + '</b>',
            icon: 'report_problem',
            timeout: storeGlobal.messagesErrorTime.low,
            textColor: 'black',
            html: true,
          })
          Loading.hide()
        }
      })
      .catch(function (err) {
        Notify.create({
          color: 'negative',
          position: 'top',
          message: '<b>Нет соединения с сервером.</b>',
          icon: 'report_problem',
          timeout: storeGlobal.messagesErrorTime.medium,
          textColor: 'black',
          html: true,
        })
        Loading.hide()
      })
  } else {
    Notify.create({
      color: 'warning',
      position: 'top',
      message: '<b>Отсутствует выделение записи ВКС</b>',
      icon: 'warning',
      timeout: storeGlobal.messagesErrorTime.low,
      textColor: 'black',
      html: true,
    })
    Loading.hide()
  }
}

const dialogSave = () => {
  Loading.show()
  if (formValidate.value.$invalid) {
    form.value.submit()
    Notify.create({
      progress: true,
      color: 'warning',
      position: 'top',
      message: '<b>Неправильно заполнены поля в форме</b>',
      icon: 'warning',
      timeout: storeGlobal.messagesErrorTime.low,
      textColor: 'black',
      html: true,
    })
    Loading.hide()
  } else {
    const vicoEdit = {
      dateTimeStart: storeGlobal.getSeconds(
        vico.value.date,
        vico.value.timeStart
      ),
      dateTimeEnd: storeGlobal.getSeconds(vico.value.date, vico.value.timeEnd),
      objectInitiator: vico.value.objectInitiator?.label ?? '',
      objectInvited: [],
      typeVico: vico.value.typeVico?.label ?? '',
      topic: vico.value.topic,
      departamentInitiator: vico.value.departamentInitiator?.label ?? '',
      departamentInvited: [],
      contactName: vico.value.contactName,
      contactPhone: vico.value.contactPhone,
    }

    vico.value.objectInvited.forEach((item) => {
      vicoEdit.objectInvited.push(item.label)
    })

    vico.value.departamentInvited.forEach((item) => {
      vicoEdit.departamentInvited.push(item.label)
    })

    api({
      method: 'post',
      url: storeGlobal.getAjaxUri('vico/edit'),
      data: {
        id: storeMain.selectId,
        vico: vicoEdit,
        user: {
          computer: storeUser.computer,
          login: storeUser.login,
          role: storeUser.role,
        },
      },
      timeout: 10000,
      responseType: 'json',
    })
      .then((response) => {
        if (response.data.success) {
          if (response.data.collision) {
            let textMessage = ''
            for (const item of response.data.message) {
              textMessage +=
                '<br />' +
                '<li>' +
                item.object +
                '&nbsp&nbsp&nbsp(<b>' +
                storeGlobal.getTime(item.timeStart) +
                '</b>--<b>' +
                storeGlobal.getTime(item.timeEnd) +
                '</b>)</li>'
            }
            Notify.create({
              progress: true,
              color: 'warning',
              position: 'top',
              message:
                '<b>В введённое время помещения для проведения ВКС заняты.</b>' +
                '<ul>' +
                textMessage +
                '</ul>',
              icon: 'warning',
              html: true,
              timeout: storeGlobal.messagesErrorTime.high,
              textColor: 'black',
            })
            Loading.hide()
          } else {
            dialog.value = false
            Loading.hide()
          }
        } else {
          Notify.create({
            progress: true,
            color: 'warning',
            position: 'top',
            message: '<b>' + response.data.message + '</b>',
            icon: 'warning',
            timeout: storeGlobal.messagesErrorTime.low,
            textColor: 'black',
            html: true,
          })
          Loading.hide()
        }
      })
      .catch(function () {
        Notify.create({
          color: 'negative',
          position: 'top',
          message: '<b>Нет соединения с сервером.</b>',
          icon: 'report_problem',
          timeout: storeGlobal.messagesErrorTime.medium,
          textColor: 'black',
          html: true,
        })
        Loading.hide()
      })
  }
}

const dialogClose = () => {
  dialog.value = false
}

defineExpose({
  dialogOpen,
})
</script>

<template>
  <q-dialog v-model="dialog" position="top" persistent>
    <q-card style="min-width: 95vw; top: 10px" flat bordered>
      <q-card-section>
        <q-form ref="form" class="q-gutter-md">
          <div class="row justify-evenly">
            <div class="col-3">
              <q-input
                v-model="vico.date"
                outlined
                mask="##.##.####"
                label-slot
                lazy-rules
                :rules="[
                  () =>
                    !formValidate.date.$invalid || 'Не корректно введена дата',
                ]">
                <template #label>
                  <span class="text-weight-bold text-indigo-10">Дата</span>
                </template>
                <template #append>
                  <i class="fa-duotone fa-calendar-days cursor-pointer">
                    <q-popup-proxy
                      cover
                      transition-show="scale"
                      transition-hide="scale">
                      <q-date v-model="vico.date" mask="DD.MM.YYYY">
                        <div class="row items-center justify-end">
                          <q-btn
                            v-close-popup
                            label="Закрыть"
                            color="primary"
                            flat />
                        </div>
                      </q-date>
                    </q-popup-proxy>
                  </i>
                </template>
              </q-input>
            </div>
            <div class="col-3">
              <q-input
                v-model="vico.timeStart"
                outlined
                mask="time"
                label-slot
                lazy-rules
                :rules="[
                  () =>
                    !formValidate.timeStart.$invalid ||
                    'Не корректно введено время',
                ]">
                <template #label>
                  <span class="text-weight-bold text-indigo-10">
                    Дата начала ВКС
                  </span>
                </template>
                <template #append>
                  <i class="fa-duotone fa-alarm-clock cursor-pointer">
                    <q-popup-proxy
                      cover
                      transition-show="scale"
                      transition-hide="scale">
                      <q-time v-model="vico.timeStart">
                        <div class="row items-center justify-end">
                          <q-btn
                            v-close-popup
                            label="Закрыть"
                            color="primary"
                            flat />
                        </div>
                      </q-time>
                    </q-popup-proxy>
                  </i>
                </template>
              </q-input>
            </div>
            <div class="col-3">
              <q-input
                v-model="vico.timeEnd"
                outlined
                mask="time"
                label-slot
                lazy-rules
                :rules="[
                  () =>
                    !formValidate.timeEnd.$invalid ||
                    'Не корректно введено время',
                ]">
                <template #label>
                  <span class="text-weight-bold text-indigo-10">
                    Дата окончания ВКС
                  </span>
                </template>
                <template #append>
                  <i class="fa-duotone fa-alarm-clock cursor-pointer">
                    <q-popup-proxy
                      cover
                      transition-show="scale"
                      transition-hide="scale">
                      <q-time v-model="vico.timeEnd">
                        <div class="row items-center justify-end">
                          <q-btn
                            v-close-popup
                            label="Закрыть"
                            color="primary"
                            flat />
                        </div>
                      </q-time>
                    </q-popup-proxy>
                  </i>
                </template>
              </q-input>
            </div>
          </div>
          <div class="row justify-evenly">
            <div class="col-6">
              <q-select
                v-model="vico.objectInitiator"
                outlined
                :options="optionObject"
                label-slot
                lazy-rules
                :rules="[
                  () =>
                    !formValidate.objectInitiator.$invalid ||
                    'Не выбрано подразделение инициатор',
                ]">
                <template #label>
                  <span class="text-weight-bold text-indigo-10">
                    Обособленное подразделение инцииатор ВКС
                  </span>
                </template>
                <template #option="scope">
                  <q-item v-bind="scope.itemProps">
                    <q-item-section>
                      <q-item-label
                        v-if="scope.selected"
                        class="text-weight-bold text-indigo-10">
                        {{ scope.opt.label }}
                      </q-item-label>
                      <q-item-label v-else>
                        {{ scope.opt.label }}
                      </q-item-label>
                    </q-item-section>
                  </q-item>
                </template>
              </q-select>
            </div>
            <div class="col-6">
              <q-select
                v-model="vico.objectInvited"
                outlined
                multiple
                :options="optionObject"
                label-slot
                style="
                  white-space: nowrap;
                  overflow: hidden;
                  text-overflow: ellipsis;
                "
                lazy-rules
                :rules="[
                  () =>
                    !formValidate.objectInvited.$invalid ||
                    'Не выбраны вызываемые обособленные подразделения',
                ]">
                <template #option="scope">
                  <q-item v-bind="scope.itemProps">
                    <q-item-section>
                      <q-item-label
                        v-if="scope.selected"
                        class="text-weight-bold text-indigo-10">
                        {{ scope.opt.label }}
                      </q-item-label>
                      <q-item-label v-else>
                        {{ scope.opt.label }}
                      </q-item-label>
                    </q-item-section>
                  </q-item>
                </template>
                <template #label>
                  <span class="text-weight-bold text-indigo-10">
                    Вызываемые обособленные подразделения
                  </span>
                </template>
              </q-select>
            </div>
          </div>
          <div class="row justify-evenly">
            <div class="col-6">
              <q-select
                v-model="vico.departamentInitiator"
                outlined
                :options="optionDepartament"
                label-slot
                lazy-rules
                :rules="[
                  () =>
                    !formValidate.departamentInitiator.$invalid ||
                    'Не выбран отдел инициатор',
                ]">
                <template #option="scope">
                  <q-item v-bind="scope.itemProps">
                    <q-item-section>
                      <q-item-label
                        v-if="scope.selected"
                        class="text-weight-bold text-indigo-10">
                        {{ scope.opt.label }}
                      </q-item-label>
                      <q-item-label v-else>
                        {{ scope.opt.label }}
                      </q-item-label>
                    </q-item-section>
                  </q-item>
                </template>
                <template #label>
                  <span class="text-weight-bold text-indigo-10">
                    Отдел инициатор ВКС
                  </span>
                </template>
              </q-select>
            </div>
            <div class="col-6">
              <q-select
                v-model="vico.departamentInvited"
                outlined
                multiple
                :options="optionDepartament"
                label-slot
                style="
                  white-space: nowrap;
                  overflow: hidden;
                  text-overflow: ellipsis;
                "
                lazy-rules
                :rules="[
                  () =>
                    !formValidate.departamentInvited.$invalid ||
                    'Не выбраны приглашённые отделы',
                ]">
                <template #option="scope">
                  <q-item v-bind="scope.itemProps">
                    <q-item-section>
                      <q-item-label
                        v-if="scope.selected"
                        class="text-weight-bold text-indigo-10">
                        {{ scope.opt.label }}
                      </q-item-label>
                      <q-item-label v-else>
                        {{ scope.opt.label }}
                      </q-item-label>
                    </q-item-section>
                  </q-item>
                </template>
                <template #label>
                  <span class="text-weight-bold text-indigo-10">
                    Приглашенные отделы
                  </span>
                </template>
              </q-select>
            </div>
          </div>
          <div class="row justify-evenly">
            <div class="col-4">
              <q-select
                v-model="vico.typeVico"
                outlined
                :options="optionTypeVico"
                label-slot
                lazy-rules
                :rules="[
                  () => !formValidate.typeVico.$invalid || 'Не выбран тип ВКС',
                ]">
                <template #option="scope">
                  <q-item v-bind="scope.itemProps">
                    <q-item-section>
                      <q-item-label
                        v-if="scope.selected"
                        class="text-weight-bold text-indigo-10">
                        {{ scope.opt.label }}
                      </q-item-label>
                      <q-item-label v-else>
                        {{ scope.opt.label }}
                      </q-item-label>
                    </q-item-section>
                  </q-item>
                </template>
                <template #label>
                  <span class="text-weight-bold text-indigo-10">
                    Тип совещания
                  </span>
                </template>
              </q-select>
            </div>
            <div class="col-4">
              <q-input
                v-model="vico.topic"
                outlined
                label-slot
                lazy-rules
                :rules="[
                  () =>
                    !formValidate.topic.$invalid ||
                    'Не заполнена тема совещания',
                ]">
                <template #label>
                  <span class="text-weight-bold text-indigo-10">
                    Тема совещания
                  </span>
                </template>
              </q-input>
            </div>
          </div>
          <div class="row justify-evenly">
            <div class="col-4">
              <q-input
                v-model="vico.contactName"
                outlined
                label-slot
                lazy-rules
                :rules="[
                  () =>
                    !formValidate.contactName.$invalid ||
                    'Не заполнено ФИО инициатора',
                ]">
                <template #label>
                  <span class="text-weight-bold text-indigo-10">
                    ФИО инициатора ВКС
                  </span>
                </template>
              </q-input>
            </div>
            <div class="col-4">
              <q-input
                v-model="vico.contactPhone"
                outlined
                label-slot
                lazy-rules
                :rules="[
                  () =>
                    !formValidate.contactPhone.$invalid ||
                    'Не заполнен контактный номер',
                ]">
                <template #label>
                  <span class="text-weight-bold text-indigo-10">
                    Контактный номер телефона инициатора ВКС
                  </span>
                </template>
              </q-input>
            </div>
          </div>
        </q-form>
      </q-card-section>
      <q-card-actions align="right" class="bg-white text-teal">
        <q-btn
          label="Отмена"
          color="red-3"
          text-color="black"
          @click="dialogClose" />
        <q-btn
          label="Сохранить"
          color="positive"
          text-color="black"
          @click="dialogSave" />
      </q-card-actions>
    </q-card>
  </q-dialog>
</template>

<style lang="sass"></style>
